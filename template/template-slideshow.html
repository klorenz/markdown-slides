<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {{#if slideshowCssPreload}}
    	<link rel="stylesheet" href="{{{baseUri}}}{{{slideshowCssPreload}}}">
    {{/if}}

    <link rel="stylesheet" href="{{{baseUri}}}assets/css/slideshow.css">
    <title>{{title}}</title>
    {{#if slideshowCss}}
    	<link rel="stylesheet" href="{{{baseUri}}}{{{slideshowCss}}}">
    {{/if}}


    <link rel="stylesheet" href="{{{baseUri}}}assets/css/mermaid.css">
    <script src="{{{baseUri}}}assets/js/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:false});</script>
    <style>
    .mermaid {
      display: none;
    }
    .mermaid-display {
      font-size: 0.5em;
    }
    </style>
  </head>
  <body>
    <textarea id="source">{{{slideMarkdown}}}</textarea>
    <script src="{{{baseUri}}}assets/js/remark.min.js"></script>
    <script>
      window.my_slideshow_mermaid_counter = 0;

      function displayMermaidDiagram() {
        var currentSlide = document.querySelector('.remark-visible')
        console.log("currentSlide", currentSlide)
        var mermaids = currentSlide.querySelectorAll('.mermaid')
        for (var i = 0; i < mermaids.length; i++) {
          var elem = mermaids[i];
          console.log("elem", elem);
          var sibling = elem.nextElementSibling;
          if (sibling) {
            if ( sibling.classList.contains('mermaid-display')) {
              elem.nextElementSibling.remove();
            }
          }
          mermaidAPI.render(
            'mermaid-figure-'+(my_slideshow_mermaid_counter++),
            elem.textContent,
            function(html) {
              var div = document.createElement('div');
              div.classList.add('mermaid-display');
              div.innerHTML = html;
              elem.parentNode.insertBefore(div, elem.nextSibling);
            }
          );
        }
      }

      var slideshow = remark.create({
         ratio: '{{ratio}}',
         highlightStyle: '{{highlightStyle}}',
         highlightLanguage: 'remark',
         highlightLines: true
      });

      slideshow.on('afterShowSlide', function(slide) {
        displayMermaidDiagram();
      });

      displayMermaidDiagram();
    </script>
    {{{autoReload}}}
  </body>
</html>
